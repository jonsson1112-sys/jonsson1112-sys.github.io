<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Empire Clone - P2P & Noise</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #222; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; image-rendering: pixelated; }
        
        /* UI Layers */
        #setup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 20px; border: 2px solid #555; z-index: 100; width: 300px; text-align: center; }
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 50; }
        
        .panel { background: rgba(0,0,0,0.8); padding: 10px; pointer-events: all; border: 1px solid #444; }
        .stats { display: flex; justify-content: space-around; font-weight: bold; font-size: 14px; }
        .controls { position: absolute; bottom: 20px; left: 10px; display: flex; gap: 10px; }
        
        /* Chat Box */
        #chat-container { position: absolute; bottom: 20px; right: 10px; width: 250px; pointer-events: all; }
        #chat-log { height: 100px; overflow-y: auto; background: rgba(0,0,0,0.5); font-size: 12px; padding: 5px; margin-bottom: 5px; border-radius: 4px; }
        #chat-input { width: 100%; background: #000; color: #0f0; border: 1px solid #444; padding: 5px; box-sizing: border-box; }

        button { background: #555; color: white; border: 1px solid #777; padding: 10px; cursor: pointer; border-radius: 4px; }
        button:active { background: #888; }
        input { padding: 8px; border-radius: 4px; border: 1px solid #444; margin: 5px 0; width: 80%; }
        
        @media (max-width: 600px) {
            #chat-container { width: 150px; }
            .stats { font-size: 11px; }
        }
    </style>
</head>
<body>

<div id="setup">
    <h2>üè∞ RTS Clone</h2>
    <p>ID: <strong id="my-id">...</strong></p>
    <input type="text" id="join-id" placeholder="Friend's ID">
    <button onclick="connectToPeer()">Connect</button>
    <hr>
    <input type="text" id="map-seed" placeholder="Map Seed (e.g. 1234)" value="1234">
    <label style="font-size: 12px;">Optional Map (PNG):</label>
    <input type="file" id="map-input" accept="image/png">
    <button onclick="startGame()" id="start-btn" style="display:none; width:100%; margin-top:10px; background: #282;">START GAME</button>
</div>

<div id="ui-overlay" style="display:none;">
    <div class="panel stats">
        <span>ü™µ Wood: <span id="res-wood">0</span></span>
        <span>üí∞ Gold: <span id="res-gold">0</span></span>
        <span>üë• Pop: <span id="res-pop">0</span></span>
    </div>

    <div class="controls">
        <button onpointerdown="spawnUnit('worker')">Worker (50W)</button>
        <button onpointerdown="spawnUnit('soldier')">Soldier (50W, 20G)</button>
    </div>

    <div id="chat-container" class="panel">
        <div id="chat-log"></div>
        <input type="text" id="chat-input" placeholder="Press Enter to chat...">
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
// --- CONFIG & GLOBALS ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE_SIZE = 40;
let peer, conn, myId = "";
let isHost = false;
let resources = { wood: 200, gold: 100 };
let gameState = { units: [], map: [], mapSize: 50 };

// --- PROCEDURAL NOISE GENERATOR ---
function mulberry32(a) {
    return function() {
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
}

function generateNoiseMap(seed) {
    const rnd = mulberry32(parseInt(seed) || 1234);
    const size = gameState.mapSize;
    let map = [];
    for(let y=0; y<size; y++) {
        map[y] = [];
        for(let x=0; x<size; x++) {
            let val = rnd(); // Simple random for terrain types
            if (val < 0.1) map[y][x] = 'WATER';
            else if (val < 0.25) map[y][x] = 'GOLD';
            else if (val < 0.45) map[y][x] = 'TREE';
            else map[y][x] = 'DIRT';
        }
    }
    return map;
}

// --- NETWORKING ---
peer = new Peer();
peer.on('open', id => { myId = id; document.getElementById('my-id').innerText = id; });

peer.on('connection', c => {
    conn = c; isHost = true;
    document.getElementById('start-btn').style.display = 'block';
    setupConnection();
});

function connectToPeer() {
    conn = peer.connect(document.getElementById('join-id').value);
    isHost = false;
    setupConnection();
}

function setupConnection() {
    conn.on('data', data => {
        if (data.type === 'STATE') gameState = data.state;
        if (data.type === 'CHAT') addChatMessage(data.sender, data.msg);
        if (data.type === 'START') {
            if (!isHost) { // Guest generates map based on seed sent by host
                gameState.map = generateNoiseMap(data.seed);
            }
            begin();
        }
    });
}

// --- GAME ACTIONS ---
function startGame() {
    const seed = document.getElementById('map-seed').value;
    const file = document.getElementById('map-input').files[0];

    if (file) {
        processImageMap(file, () => finishStart(seed));
    } else {
        gameState.map = generateNoiseMap(seed);
        finishStart(seed);
    }
}

function finishStart(seed) {
    conn.send({ type: 'START', seed: seed });
    begin();
}

function begin() {
    document.getElementById('setup').style.display = 'none';
    document.getElementById('ui-overlay').style.display = 'block';
    setInterval(gameLoop, 1000/60);
}

function spawnUnit(type) {
    if (type === 'worker' && resources.wood < 50) return;
    if (type === 'worker') resources.wood -= 50;
    
    const unit = {
        id: Math.random(),
        owner: myId,
        type: type,
        x: 100 + (Math.random()*50), y: 100 + (Math.random()*50),
        tx: 100, ty: 100
    };
    gameState.units.push(unit);
}

// --- CHAT LOGIC ---
const chatInput = document.getElementById('chat-input');
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && chatInput.value.trim() !== "") {
        const msg = chatInput.value;
        addChatMessage("Me", msg);
        conn.send({ type: 'CHAT', sender: myId.substring(0,4), msg: msg });
        chatInput.value = "";
    }
});

function addChatMessage(sender, msg) {
    const log = document.getElementById('chat-log');
    log.innerHTML += `<div><strong>${sender}:</strong> ${msg}</div>`;
    log.scrollTop = log.scrollHeight;
}

// --- ENGINE ---
function gameLoop() {
    updateUnits();
    draw();
    if (isHost && conn) conn.send({ type: 'STATE', state: gameState });
}

function updateUnits() {
    gameState.units.forEach(u => {
        const dx = u.tx - u.x;
        const dy = u.ty - u.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 5) {
            u.x += (dx / dist) * 3;
            u.y += (dy / dist) * 3;
        }
    });
}

function draw() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    ctx.clearRect(0,0, canvas.width, canvas.height);

    // Map
    gameState.map.forEach((row, y) => {
        row.forEach((tile, x) => {
            if (tile === 'DIRT') ctx.fillStyle = '#6d4c41';
            else if (tile === 'TREE') ctx.fillStyle = '#2e7d32';
            else if (tile === 'GOLD') ctx.fillStyle = '#fbc02d';
            else if (tile === 'WATER') ctx.fillStyle = '#0277bd';
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        });
    });

    // Units
    gameState.units.forEach(u => {
        ctx.fillStyle = u.owner === myId ? '#fff' : '#f44';
        ctx.beginPath();
        ctx.arc(u.x, u.y, 12, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "black";
        ctx.font = "10px Arial";
        ctx.fillText(u.type[0].toUpperCase(), u.x-4, u.y+4);
    });
    
    document.getElementById('res-wood').innerText = resources.wood;
    document.getElementById('res-gold').innerText = resources.gold;
}

// Input (Mobile & Desktop)
canvas.addEventListener('pointerdown', (e) => {
    if (e.target.id !== "gameCanvas") return;
    gameState.units.forEach(u => {
        if (u.owner === myId) {
            u.tx = e.clientX;
            u.ty = e.clientY;
        }
    });
});

function processImageMap(file, callback) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const tCanvas = document.createElement('canvas');
            tCanvas.width = img.width; tCanvas.height = img.height;
            const tCtx = tCanvas.getContext('2d');
            tCtx.drawImage(img, 0, 0);
            const data = tCtx.getImageData(0,0, img.width, img.height).data;
            gameState.map = [];
            for (let y = 0; y < img.height; y++) {
                gameState.map[y] = [];
                for (let x = 0; x < img.width; x++) {
                    const i = (y * img.width + x) * 4;
                    const r = data[i], g = data[i+1], b = data[i+2];
                    if (g > 150 && r < 100) gameState.map[y][x] = 'TREE';
                    else if (r > 200 && g > 180) gameState.map[y][x] = 'GOLD';
                    else if (b > 200) gameState.map[y][x] = 'WATER';
                    else gameState.map[y][x] = 'DIRT';
                }
            }
            callback();
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}
</script>
</body>
</html>
