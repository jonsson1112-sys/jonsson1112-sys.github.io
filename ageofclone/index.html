<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Empire Clone - Authoritative Sync</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #ff9800; --bg: #1a1a1a; --glass: rgba(25, 25, 25, 0.95); }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; }

        /* Full Screen Setup */
        #setup { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        
        /* Fixed Top Bar - Mobile Optimized */
        #top-bar { 
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: var(--glass); border-bottom: 2px solid #444;
            display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center;
            z-index: 1000; pointer-events: all; text-align: center;
        }
        .res-item { font-size: 16px; font-weight: bold; }

        /* Left Sidebar Tools */
        #toolbar {
            position: absolute; left: 12px; top: 80px; 
            display: flex; flex-direction: column; gap: 12px;
            z-index: 1000; pointer-events: all;
        }
        .tool-btn {
            width: 55px; height: 55px; background: var(--glass); border: 2px solid #555;
            color: white; border-radius: 12px; font-size: 24px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn.active { border-color: var(--p); background: #3d2b00; box-shadow: 0 0 10px var(--p); }

        /* Bottom Action Bar */
        #action-bar {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; pointer-events: all; z-index: 1000; width: 95%; justify-content: center;
        }
        .spawn-btn {
            background: var(--glass); border: 1px solid #666; padding: 10px;
            border-radius: 8px; flex: 1; max-width: 110px; text-align: center; font-size: 11px;
        }
        .spawn-btn b { display: block; color: var(--p); font-size: 13px; margin-bottom: 2px; }

        .hidden { display: none !important; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div id="setup">
    <h1 style="color:var(--p)">EMPIRE P2P</h1>
    <div id="lobby-ui">
        <p>Your Game ID: <b id="my-id">...</b></p>
        <button onclick="copyLink()" style="padding:10px; margin-bottom:10px;">üîó Copy Invite Link</button><br>
        <input type="text" id="join-id" placeholder="Paste ID here" style="padding:12px; width:200px; border-radius:8px;"><br>
        <button onclick="connect()" style="padding:12px 30px; margin-top:10px; background:var(--p); border:none; border-radius:8px; font-weight:bold;">Join Friend</button>
        <div id="host-tools" class="hidden">
            <hr style="width:100%; border:0; border-top:1px solid #444; margin:20px 0;">
            <button onclick="startGame()" style="background:#2e7d32; color:white; padding: 20px 50px; border-radius: 12px; font-size:18px; border:none; font-weight:bold;">START MISSION</button>
        </div>
    </div>
</div>

<div id="top-bar" class="hidden">
    <div class="res-item">ü™µ <span id="res-wood">0</span></div>
    <div class="res-item">üí∞ <span id="res-gold">0</span></div>
    <div class="res-item">‚öîÔ∏è <span id="res-pop">0</span></div>
</div>

<div id="toolbar" class="hidden">
    <button class="tool-btn active" id="btn-pan" onclick="setTool('pan')">üñêÔ∏è</button>
    <button class="tool-btn" id="btn-select" onclick="setTool('select')">üñ±Ô∏è</button>
    <button class="tool-btn" id="btn-action" onclick="setTool('action')">üéØ</button>
</div>

<div id="action-bar" class="hidden">
    <div class="spawn-btn" onclick="spawn('worker')"><b>WORKER</b>50W</div>
    <div class="spawn-btn" onclick="spawn('barracks')"><b>BARRACKS</b>100W</div>
    <div class="spawn-btn" onclick="spawn('soldier')"><b>SOLDIER</b>50W 20G</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 48, MAP_SIZE = 50;

let peer, conn, myId = "";
let isHost = false;
let resources = { wood: 200, gold: 100 };
let cam = { x: 0, y: 0, z: 0.75 };
let currentTool = 'pan'; 
let selection = { start: null, current: null, ids: [] };
let gameState = { units: [], map: [], buildings: [] };

// --- TOOL SETTINGS ---
function setTool(tool) {
    currentTool = tool;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + tool).classList.add('active');
}

// --- NETWORK CORE ---
peer = new Peer();
peer.on('open', id => {
    myId = id; document.getElementById('my-id').innerText = id;
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('join')) document.getElementById('join-id').value = urlParams.get('join');
});

peer.on('connection', c => {
    conn = c; isHost = true;
    document.getElementById('host-tools').classList.remove('hidden');
    setupConn();
});

function connect() {
    conn = peer.connect(document.getElementById('join-id').value);
    isHost = false; 
    setupConn();
}

function setupConn() {
    conn.on('data', data => {
        if(data.type === 'SYNC') {
            // Client simply receives the Host's truth
            gameState.units = data.units;
            gameState.buildings = data.buildings;
            if(!isHost) resources = data.res[myId] || resources;
        }
        if(data.type === 'START') { gameState.map = data.map; initGame(); }
        if(data.type === 'CMD') handleCommand(data); // Host receives command
        if(data.type === 'SPAWN_REQ') spawnAt(data.sender, data.unitType);
    });
}

// --- GAMEPLAY ENGINE ---
function startGame() {
    // Generate Map
    gameState.map = Array.from({length: MAP_SIZE}, () => Array.from({length: MAP_SIZE}, () => 
        Math.random() < 0.1 ? 'TREE' : (Math.random() < 0.03 ? 'GOLD' : 'DIRT')));
    
    // Create Bases
    createBuilding(myId, 'base', 5*TILE, 5*TILE);
    createBuilding(conn.peer, 'base', (MAP_SIZE-6)*TILE, (MAP_SIZE-6)*TILE);
    
    // Initial Units
    spawnAt(myId, 'worker', 6*TILE, 6*TILE);
    spawnAt(conn.peer, 'worker', (MAP_SIZE-7)*TILE, (MAP_SIZE-7)*TILE);

    conn.send({ type: 'START', map: gameState.map });
    initGame();
}

function initGame() {
    document.getElementById('setup').classList.add('hidden');
    ['top-bar', 'toolbar', 'action-bar'].forEach(id => document.getElementById(id).classList.remove('hidden'));
    
    // Position camera on your base
    const myBase = gameState.buildings.find(b => b.owner === myId);
    if(myBase) {
        cam.x = myBase.x - window.innerWidth/2;
        cam.y = myBase.y - window.innerHeight/2;
    }
    requestAnimationFrame(loop);
}

function loop() {
    if (isHost) {
        // ONLY the Host moves units
        gameState.units.forEach(u => {
            const dx = u.tx - u.x, dy = u.ty - u.y;
            const dist = Math.hypot(dx, dy);
            if(dist > 2) {
                u.x += (dx/dist)*4;
                u.y += (dy/dist)*4;
            } else if (u.type === 'worker') {
                updateWorkerGathering(u);
            }
        });
        
        // Broadcast the new positions to the Client
        if(conn) conn.send({ 
            type: 'SYNC', 
            units: gameState.units, 
            buildings: gameState.buildings,
            res: { [myId]: resources, [conn.peer]: {wood: 100, gold: 50} } // Simple res sync logic
        });
    }

    draw();
    requestAnimationFrame(loop);
}

function updateWorkerGathering(u) {
    const base = gameState.buildings.find(b => b.owner === u.owner && b.type === 'base');
    const tile = gameState.map[Math.floor(u.y/TILE)]?.[Math.floor(u.x/TILE)];
    if (!u.cargo && (tile === 'TREE' || tile === 'GOLD')) {
        u.cargo = tile; u.lx = u.x; u.ly = u.y; u.tx = base.x; u.ty = base.y;
    } else if (u.cargo && base && Math.hypot(u.x-base.x, u.y-base.y) < 40) {
        // Increment resources on Host
        if(u.owner === myId) resources[u.cargo === 'TREE' ? 'wood' : 'gold'] += 10;
        u.cargo = null; u.tx = u.lx; u.ty = u.ly;
    }
}

// --- RENDERER ---
function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.clearRect(0,0,canvas.width, canvas.height);
    
    ctx.save();
    // Apply Camera
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(cam.z, cam.z);
    ctx.translate(-cam.x - canvas.width/2, -cam.y - canvas.height/2);

    // Draw Map
    for(let y=0; y<MAP_SIZE; y++) {
        for(let x=0; x<MAP_SIZE; x++) {
            const t = gameState.map[y][x];
            ctx.fillStyle = t === 'TREE' ? '#1b5e20' : (t === 'GOLD' ? '#ffd600' : '#3e2723');
            ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
        }
    }

    // Draw Buildings
    gameState.buildings.forEach(b => {
        ctx.fillStyle = b.owner === myId ? '#2196f3' : '#f44336';
        ctx.fillRect(b.x-40, b.y-40, 80, 80);
        ctx.fillStyle = 'white'; ctx.textAlign = 'center';
        ctx.fillText(b.type.toUpperCase(), b.x, b.y);
    });

    // Draw Units
    gameState.units.forEach(u => {
        const isSel = selection.ids.includes(u.id);
        ctx.beginPath();
        ctx.fillStyle = u.owner === myId ? (isSel ? '#00e5ff' : '#fff') : '#f44336';
        ctx.arc(u.x, u.y, 16, 0, Math.PI*2);
        ctx.fill();
        if(isSel) { ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke(); }
        
        if(u.cargo) {
            ctx.fillStyle = u.cargo === 'TREE' ? '#4caf50' : '#ffeb3b';
            ctx.fillRect(u.x-6, u.y-28, 12, 12);
        }
    });

    // Selection Box (Screen Space)
    ctx.restore();
    if (currentTool === 'select' && selection.start && selection.current) {
        ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2;
        ctx.strokeRect(selection.start.x, selection.start.y, selection.current.x-selection.start.x, selection.current.y-selection.start.y);
    }

    // UI Updates
    document.getElementById('res-wood').innerText = resources.wood;
    document.getElementById('res-gold').innerText = resources.gold;
    document.getElementById('res-pop').innerText = gameState.units.filter(u=>u.owner===myId).length;
}

// --- CONTROLS ---
let isDown = false;
canvas.addEventListener('pointerdown', e => {
    isDown = true;
    selection.start = {x: e.clientX, y: e.clientY};
    selection.current = {x: e.clientX, y: e.clientY};
});

window.addEventListener('pointermove', e => {
    if(!isDown) return;
    const dx = e.clientX - selection.current.x;
    const dy = e.clientY - selection.current.y;
    
    if (currentTool === 'pan') {
        cam.x -= dx / cam.z;
        cam.y -= dy / cam.z;
    }
    selection.current = {x: e.clientX, y: e.clientY};
});

window.addEventListener('pointerup', e => {
    if(!isDown) return;
    isDown = false;

    const s = screenToWorld(selection.start.x, selection.start.y);
    const c = screenToWorld(selection.current.x, selection.current.y);

    if (currentTool === 'select') {
        const xMin = Math.min(s.x, c.x), xMax = Math.max(s.x, c.x);
        const yMin = Math.min(s.y, c.y), yMax = Math.max(s.y, c.y);
        
        // Selection works for both Host and Client
        selection.ids = gameState.units.filter(u => 
            u.owner === myId && u.x > xMin && u.x < xMax && u.y > yMin && u.y < yMax
        ).map(u => u.id);
        
        if(selection.ids.length > 0) setTool('action'); 
    } 
    else if (currentTool === 'action') {
        commandUnits(c.x, c.y); // Use current world pos
    }
    selection.start = selection.current = null;
});

function screenToWorld(sx, sy) {
    return {
        x: (sx - canvas.width/2) / cam.z + cam.x + canvas.width/2,
        y: (sy - canvas.height/2) / cam.z + cam.y + canvas.height/2
    };
}

function commandUnits(tx, ty) {
    if(!selection.ids.length) return;
    const data = { type: 'CMD', ids: selection.ids, tx, ty };
    if(isHost) handleCommand(data); else conn.send(data);
}

function handleCommand(data) {
    // Only the Host modifies the actual unit data
    gameState.units.filter(u => data.ids.includes(u.id)).forEach(u => { 
        u.tx = data.tx; u.ty = data.ty; u.cargo = null; 
    });
}

function spawn(type) {
    const cost = type === 'barracks' ? 100 : 50;
    if(resources.wood >= cost) {
        if(isHost) spawnAt(myId, type);
        else conn.send({type: 'SPAWN_REQ', sender: myId, unitType: type});
        resources.wood -= cost;
    }
}

function spawnAt(owner, type, x, y) {
    const b = gameState.buildings.find(b => b.owner === owner);
    if (!b) return;
    if(type === 'barracks') {
        createBuilding(owner, 'barracks', b.x + TILE*2, b.y);
    } else {
        gameState.units.push({ id: Math.random(), owner, type, x: x||b.x, y: y||b.y, tx: x||b.x, ty: y||b.y, cargo: null });
    }
}

function createBuilding(owner, type, x, y) {
    gameState.buildings.push({ id: Math.random(), owner, type, x, y });
}

function copyLink() {
    const link = window.location.origin + window.location.pathname + "?join=" + myId;
    navigator.clipboard.writeText(link);
    alert("Invite Link Copied!");
}
</script>
</body>
</html>
