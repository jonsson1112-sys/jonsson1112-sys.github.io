<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Empire Clone - Tool System</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #ff9800; --s: #2196f3; --bg: #1a1a1a; --glass: rgba(30, 30, 30, 0.9); }
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; }

        /* Setup Screen */
        #setup { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; padding: 20px; text-align: center; }
        
        /* Redesigned Top Bar */
        #top-bar { 
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: var(--glass); border-bottom: 2px solid #444;
            display: flex; align-items: center; justify-content: space-around;
            z-index: 1000; pointer-events: all;
        }
        .res-item { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 14px; }

        /* Blender-style Toolbar */
        #toolbar {
            position: absolute; left: 10px; top: 70px; 
            display: flex; flex-direction: column; gap: 10px;
            z-index: 1000; pointer-events: all;
        }
        .tool-btn {
            width: 50px; height: 50px; background: var(--glass); border: 2px solid #555;
            color: white; border-radius: 8px; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn.active { border-color: var(--p); background: #443311; }

        /* Action/Spawn Panel (Bottom) */
        #action-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: all; z-index: 1000;
        }
        .action-btn {
            background: var(--glass); border: 2px solid #555; padding: 10px 15px;
            border-radius: 10px; text-align: center; font-size: 12px;
        }
        .action-btn b { display: block; color: var(--p); font-size: 14px; }

        input { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #000; color: white; width: 220px; margin: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="setup">
    <h1 style="color:var(--p)">EMPIRE P2P</h1>
    <p>ID: <b id="my-id">...</b></p>
    <button class="tool-btn" style="width:200px" onclick="copyLink()">Copy Invite Link</button>
    <input type="text" id="join-id" placeholder="Paste Friend's ID">
    <button class="tool-btn" style="width:200px" onclick="connect()">Join Friend</button>
    <div id="host-controls" class="hidden">
        <button onclick="startGame()" style="background:green; color:white; padding: 20px 40px; border-radius: 10px; margin-top:20px;">START MISSION</button>
    </div>
</div>

<div id="top-bar" class="hidden">
    <div class="res-item">ü™µ <span id="res-wood">0</span></div>
    <div class="res-item">üí∞ <span id="res-gold">0</span></div>
    <div class="res-item">‚öîÔ∏è <span id="res-pop">0</span>/50</div>
</div>

<div id="toolbar" class="hidden">
    <button class="tool-btn active" id="btn-pan" onclick="setTool('pan')" title="Pan Camera">üñêÔ∏è</button>
    <button class="tool-btn" id="btn-select" onclick="setTool('select')" title="Select Units">üñ±Ô∏è</button>
    <button class="tool-btn" id="btn-action" onclick="setTool('action')" title="Command/Move">üéØ</button>
</div>

<div id="action-bar" class="hidden">
    <div class="action-btn" onclick="spawn('worker')"><b>WORKER</b>50 Wood</div>
    <div class="action-btn" onclick="spawn('barracks')"><b>BARRACKS</b>100 Wood</div>
    <div class="action-btn" onclick="spawn('soldier')"><b>SOLDIER</b>50W 20G</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 48, MAP_SIZE = 50;

let peer, conn, myId = "";
let isHost = false;
let resources = { wood: 200, gold: 100 };
let cam = { x: 0, y: 0, z: 0.7 };
let currentTool = 'pan'; // 'pan', 'select', 'action'
let selection = { start: null, current: null, ids: [] };
let gameState = { units: [], map: [], buildings: [] };

// --- TOOL SYSTEM ---
function setTool(tool) {
    currentTool = tool;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + tool).classList.add('active');
}

// --- NETWORKING ---
peer = new Peer();
peer.on('open', id => {
    myId = id; document.getElementById('my-id').innerText = id;
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('join')) document.getElementById('join-id').value = urlParams.get('join');
});

peer.on('connection', c => {
    conn = c; isHost = true;
    document.getElementById('host-controls').classList.remove('hidden');
    setupConn();
});

function connect() {
    conn = peer.connect(document.getElementById('join-id').value);
    isHost = false; setupConn();
}

function setupConn() {
    conn.on('data', data => {
        if(data.type === 'SYNC') syncState(data.state);
        if(data.type === 'START') { gameState.map = data.map; initGame(); }
        if(data.type === 'CMD') handleCommand(data);
        if(data.type === 'SPAWN_REQ') spawnAt(data.sender, data.unitType, data.x, data.y);
    });
}

function syncState(srv) {
    // Smoothed Sync
    srv.units.forEach(su => {
        let lu = gameState.units.find(u => u.id === su.id);
        if(lu) { 
            lu.tx = su.tx; lu.ty = su.ty; lu.hp = su.hp; lu.cargo = su.cargo;
            if(Math.hypot(lu.x - su.x, lu.y - su.y) > 100) { lu.x = su.x; lu.y = su.y; }
        } else gameState.units.push(su);
    });
    gameState.units = gameState.units.filter(u => srv.units.some(su => su.id === u.id));
    gameState.buildings = srv.buildings;
}

// --- INITIALIZATION ---
function startGame() {
    gameState.map = Array.from({length: MAP_SIZE}, () => Array.from({length: MAP_SIZE}, () => 
        Math.random() < 0.1 ? 'TREE' : (Math.random() < 0.03 ? 'GOLD' : 'DIRT')));
    createBuilding(myId, 'base', 5*TILE, 5*TILE);
    createBuilding(conn.peer, 'base', (MAP_SIZE-6)*TILE, (MAP_SIZE-6)*TILE);
    spawnAt(myId, 'worker', 6*TILE, 6*TILE);
    spawnAt(conn.peer, 'worker', (MAP_SIZE-7)*TILE, (MAP_SIZE-7)*TILE);
    conn.send({ type: 'START', map: gameState.map });
    initGame();
}

function initGame() {
    document.getElementById('setup').classList.add('hidden');
    ['top-bar', 'toolbar', 'action-bar'].forEach(id => document.getElementById(id).classList.remove('hidden'));
    cam.x = isHost ? 0 : (MAP_SIZE*TILE - window.innerWidth);
    cam.y = isHost ? 0 : (MAP_SIZE*TILE - window.innerHeight);
    requestAnimationFrame(loop);
}

// --- ENGINE ---
function loop() {
    gameState.units.forEach(u => {
        const dx = u.tx - u.x, dy = u.ty - u.y;
        const dist = Math.hypot(dx, dy);
        if(dist > 2) { u.x += (dx/dist)*4; u.y += (dy/dist)*4; }
        
        if (isHost && u.type === 'worker') {
            const base = gameState.buildings.find(b => b.owner === u.owner && b.type === 'base');
            const tile = gameState.map[Math.floor(u.y/TILE)]?.[Math.floor(u.x/TILE)];
            if (!u.cargo && (tile === 'TREE' || tile === 'GOLD')) {
                u.cargo = tile; u.lx = u.x; u.ly = u.y; u.tx = base.x; u.ty = base.y;
            } else if (u.cargo && base && Math.hypot(u.x-base.x, u.y-base.y) < 50) {
                if (u.owner === myId) resources[u.cargo === 'TREE' ? 'wood' : 'gold'] += 10;
                u.cargo = null; u.tx = u.lx; u.ty = u.ly;
            }
        }
    });

    draw();
    if(isHost && conn) conn.send({ type: 'SYNC', state: gameState });
    requestAnimationFrame(loop);
}

function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(cam.z, cam.z);
    ctx.translate(-cam.x - canvas.width/2, -cam.y - canvas.height/2);

    // Tiles
    for(let y=0; y<MAP_SIZE; y++) {
        for(let x=0; x<MAP_SIZE; x++) {
            const t = gameState.map[y][x];
            ctx.fillStyle = t === 'TREE' ? '#1b5e20' : (t === 'GOLD' ? '#ffd600' : '#4d3319');
            ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
        }
    }

    // Objects
    [...gameState.buildings, ...gameState.units].forEach(obj => {
        const isSel = selection.ids.includes(obj.id);
        ctx.fillStyle = obj.owner === myId ? (isSel ? '#00e5ff' : '#2196f3') : '#f44336';
        if (obj.type === 'base' || obj.type === 'barracks') {
            ctx.fillRect(obj.x-40, obj.y-40, 80, 80);
            ctx.fillStyle = 'white'; ctx.fillText(obj.type.toUpperCase(), obj.x-25, obj.y);
        } else {
            ctx.beginPath(); ctx.arc(obj.x, obj.y, 15, 0, Math.PI*2); ctx.fill();
            if(obj.cargo) { ctx.fillStyle = obj.cargo==='TREE'?'#0f0':'#ff0'; ctx.fillRect(obj.x-5, obj.y-25, 10, 10); }
        }
    });

    // Selection Box Overlay
    if (currentTool === 'select' && selection.start && selection.current) {
        ctx.restore();
        ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2;
        ctx.strokeRect(selection.start.x, selection.start.y, selection.current.x-selection.start.x, selection.current.y-selection.start.y);
        ctx.save();
    }
    ctx.restore();

    document.getElementById('res-wood').innerText = resources.wood;
    document.getElementById('res-gold').innerText = resources.gold;
    document.getElementById('res-pop').innerText = gameState.units.filter(u=>u.owner===myId).length;
}

// --- TOOL-BASED INTERACTION ---
let isDown = false;
let lastTouches = [];

canvas.addEventListener('pointerdown', e => {
    isDown = true;
    selection.start = {x: e.clientX, y: e.clientY};
    selection.current = {x: e.clientX, y: e.clientY};
});

window.addEventListener('pointermove', e => {
    if(!isDown) return;
    const dx = e.clientX - selection.current.x;
    const dy = e.clientY - selection.current.y;
    
    if (currentTool === 'pan') {
        cam.x -= dx / cam.z;
        cam.y -= dy / cam.z;
    }
    selection.current = {x: e.clientX, y: e.clientY};
});

window.addEventListener('pointerup', e => {
    if(!isDown) return;
    isDown = false;

    if (currentTool === 'select') {
        const s = screenToWorld(selection.start.x, selection.start.y);
        const c = screenToWorld(selection.current.x, selection.current.y);
        const xMin = Math.min(s.x, c.x), xMax = Math.max(s.x, c.x);
        const yMin = Math.min(s.y, c.y), yMax = Math.max(s.y, c.y);
        
        selection.ids = gameState.units.filter(u => 
            u.owner === myId && u.x > xMin && u.x < xMax && u.y > yMin && u.y < yMax
        ).map(u => u.id);
        
        if(selection.ids.length > 0) setTool('action'); // Auto-switch to action after selecting
    } 
    else if (currentTool === 'action') {
        const w = screenToWorld(e.clientX, e.clientY);
        commandUnits(w.x, w.y);
    }
    
    selection.start = selection.current = null;
});

// Pinch Zoom logic
window.addEventListener('wheel', e => {
    cam.z = Math.min(Math.max(cam.z - e.deltaY * 0.001, 0.2), 2);
});

function screenToWorld(sx, sy) {
    return {
        x: (sx - canvas.width/2) / cam.z + cam.x + canvas.width/2,
        y: (sy - canvas.height/2) / cam.z + cam.y + canvas.height/2
    };
}

function commandUnits(tx, ty) {
    if(!selection.ids.length) return;
    const data = { type: 'CMD', ids: selection.ids, tx, ty };
    if(isHost) handleCommand(data); else conn.send(data);
}

function handleCommand(data) {
    gameState.units.filter(u => data.ids.includes(u.id)).forEach(u => { 
        u.tx = data.tx; u.ty = data.ty; u.cargo = null; 
    });
}

function spawn(type) {
    const costWood = type === 'barracks' ? 100 : 50;
    const costGold = type === 'soldier' ? 20 : 0;
    if(resources.wood >= costWood && resources.gold >= costGold) {
        resources.wood -= costWood; resources.gold -= costGold;
        if(isHost) {
            if(type === 'barracks') createBuilding(myId, 'barracks', 10*TILE, 10*TILE);
            else spawnAt(myId, type);
        } else {
            conn.send({type: 'SPAWN_REQ', sender: myId, unitType: type});
        }
    }
}

function spawnAt(owner, type, x, y) {
    const b = gameState.buildings.find(b => b.owner === owner);
    if (!b) return;
    gameState.units.push({ id: Math.random(), owner, type, x: x || b.x, y: y || b.y, tx: x || b.x, ty: y || b.y, hp: 100, cargo: null });
}

function createBuilding(owner, type, x, y) {
    gameState.buildings.push({ id: Math.random(), owner, type, x, y, hp: 500 });
}

function copyLink() {
    navigator.clipboard.writeText(window.location.origin + window.location.pathname + "?join=" + myId);
    alert("Link Copied!");
}
</script>
</body>
</html>
