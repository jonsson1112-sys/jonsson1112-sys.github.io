<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Empire P2P Clone</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #fb8c00; --bg: #222; }
        body { margin: 0; background: var(--bg); color: white; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; image-rendering: pixelated; background: #333; }
        
        /* UI Layers */
        #setup { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 20px; text-align: center; }
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 50; display: none; }
        
        .panel { background: rgba(0,0,0,0.85); padding: 12px; pointer-events: all; border-bottom: 2px solid #444; }
        .stats { display: flex; justify-content: space-around; font-weight: bold; font-size: 1.1rem; }
        .controls { position: absolute; bottom: 20px; left: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        #chat-container { position: absolute; bottom: 20px; right: 10px; width: 220px; pointer-events: all; }
        #chat-log { height: 80px; overflow-y: auto; background: rgba(0,0,0,0.4); font-size: 12px; padding: 5px; margin-bottom: 5px; }
        #chat-input { width: 100%; background: #000; color: #0f0; border: 1px solid #555; padding: 8px; box-sizing: border-box; }

        button { background: #444; color: white; border: 1px solid #666; padding: 12px 20px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        button:active { background: var(--primary); }
        .btn-start { background: #2e7d32; width: 100%; margin-top: 15px; font-size: 1.2rem; }
        
        input { padding: 12px; border-radius: 8px; border: 1px solid #444; margin: 8px 0; width: 260px; background: #111; color: white; }
        .share-box { margin-top: 10px; font-size: 0.8rem; color: #aaa; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div id="setup">
    <h1 style="color:var(--primary); margin-bottom:0;">EMPIRE CLONE</h1>
    <p id="status">Initializing Network...</p>
    
    <div id="connection-controls">
        <p>Your ID: <strong id="my-id">...</strong></p>
        <div class="share-box" onclick="copyShareLink()">ðŸ”— Click to copy Invite Link</div>
        <br>
        <input type="text" id="join-id" placeholder="Paste Friend's ID">
        <button onclick="connectToPeer()">Connect to Friend</button>
    </div>

    <div id="host-controls" style="display:none; margin-top:20px; border-top: 1px solid #444; width: 100%;">
        <p>Connected! Set up map:</p>
        <input type="text" id="map-seed" placeholder="Map Seed" value="1234">
        <label style="display:block; font-size: 12px; margin-top:5px;">Or use custom PNG:</label>
        <input type="file" id="map-input" accept="image/png">
        <button onclick="startGame()" class="btn-start">START GAME</button>
    </div>
</div>

<div id="ui-overlay">
    <div class="panel stats">
        <span>ðŸªµ <span id="res-wood">0</span></span>
        <span>ðŸ’° <span id="res-gold">0</span></span>
    </div>

    <div class="controls">
        <button onpointerdown="requestSpawn('worker')">Train Worker (50W)</button>
        <button onpointerdown="requestSpawn('soldier')">Train Soldier (50W, 20G)</button>
    </div>

    <div id="chat-container" class="panel">
        <div id="chat-log"></div>
        <input type="text" id="chat-input" placeholder="Chat...">
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE_SIZE = 48;
const MAP_SIZE = 50;

let peer, conn, myId = "";
let isHost = false;
let resources = { wood: 200, gold: 100 };
let gameState = { units: [], map: [] };

// --- MAP GENERATION ---
function generateProceduralMap(seed) {
    const rnd = () => {
        seed = (seed * 9301 + 49297) % 233280;
        return seed / 233280;
    };
    let s = parseInt(seed);
    let map = [];
    for(let y=0; y<MAP_SIZE; y++) {
        map[y] = [];
        for(let x=0; x<MAP_SIZE; x++) {
            let v = rnd();
            if (v < 0.05) map[y][x] = 'WATER';
            else if (v < 0.12) map[y][x] = 'GOLD';
            else if (v < 0.25) map[y][x] = 'TREE';
            else map[y][x] = 'DIRT';
        }
    }
    return map;
}

// --- NETWORK & LOBBY ---
peer = new Peer();
peer.on('open', id => { 
    myId = id; 
    document.getElementById('my-id').innerText = id;
    document.getElementById('status').innerText = "Ready to Play";
    
    // Check for auto-join URL
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.has('join')) {
        document.getElementById('join-id').value = urlParams.get('join');
    }
});

peer.on('connection', c => {
    conn = c; isHost = true;
    document.getElementById('host-controls').style.display = 'block';
    document.getElementById('connection-controls').style.display = 'none';
    setupConnection();
});

function connectToPeer() {
    const targetId = document.getElementById('join-id').value;
    if(!targetId) return alert("Enter an ID");
    conn = peer.connect(targetId);
    isHost = false;
    setupConnection();
    document.getElementById('status').innerText = "Connecting to Host...";
}

function setupConnection() {
    conn.on('data', data => {
        if (data.type === 'SYNC') gameState = data.state;
        if (data.type === 'CHAT') addChat(data.sender, data.msg);
        if (data.type === 'SPAWN_REQ') handleSpawnRequest(data);
        if (data.type === 'START') {
            gameState.map = data.map;
            beginGame();
        }
    });
}

function copyShareLink() {
    const link = window.location.origin + window.location.pathname + "?join=" + myId;
    navigator.clipboard.writeText(link);
    alert("Invite link copied! Send it to your friend.");
}

// --- GAME CORE ---
function startGame() {
    const file = document.getElementById('map-input').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const tc = document.createElement('canvas');
                tc.width = tc.height = MAP_SIZE;
                const tx = tc.getContext('2d');
                tx.drawImage(img, 0, 0, MAP_SIZE, MAP_SIZE);
                const pix = tx.getImageData(0,0,MAP_SIZE,MAP_SIZE).data;
                gameState.map = [];
                for(let y=0; y<MAP_SIZE; y++) {
                    gameState.map[y] = [];
                    for(let x=0; x<MAP_SIZE; x++) {
                        let i = (y * MAP_SIZE + x) * 4;
                        if (pix[i+2] > 200) gameState.map[y][x] = 'WATER';
                        else if (pix[i] > 200 && pix[i+1] > 180) gameState.map[y][x] = 'GOLD';
                        else if (pix[i+1] > 150) gameState.map[y][x] = 'TREE';
                        else gameState.map[y][x] = 'DIRT';
                    }
                }
                finalizeStart();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        gameState.map = generateProceduralMap(document.getElementById('map-seed').value);
        finalizeStart();
    }
}

function finalizeStart() {
    // Initial Spawns
    spawnGroup(myId, 2, 2); // Host top-left
    spawnGroup(conn.peer, MAP_SIZE - 4, MAP_SIZE - 4); // Guest bottom-right
    
    conn.send({ type: 'START', map: gameState.map });
    beginGame();
}

function spawnGroup(owner, startX, startY) {
    for(let i=0; i<3; i++) createUnit(owner, 'worker', (startX+i)*TILE_SIZE, startY*TILE_SIZE);
    createUnit(owner, 'soldier', startX*TILE_SIZE, (startY+1)*TILE_SIZE);
}

function createUnit(owner, type, x, y) {
    gameState.units.push({
        id: Math.random().toString(36).substr(2, 9),
        owner, type, x, y, tx: x, ty: y
    });
}

function beginGame() {
    document.getElementById('setup').style.display = 'none';
    document.getElementById('ui-overlay').style.display = 'block';
    requestAnimationFrame(gameLoop);
}

// --- LOGIC & RENDERING ---
function gameLoop() {
    // Movement logic
    gameState.units.forEach(u => {
        const dx = u.tx - u.x;
        const dy = u.ty - u.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 2) {
            u.x += (dx / dist) * 3;
            u.y += (dy / dist) * 3;
        }
    });

    // Rendering
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // Draw visible map tiles
    gameState.map.forEach((row, y) => {
        row.forEach((tile, x) => {
            if (tile === 'DIRT') ctx.fillStyle = '#795548';
            else if (tile === 'TREE') ctx.fillStyle = '#2e7d32';
            else if (tile === 'GOLD') ctx.fillStyle = '#ffd600';
            else if (tile === 'WATER') ctx.fillStyle = '#0288d1';
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            ctx.strokeStyle = "rgba(0,0,0,0.05)";
            ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        });
    });

    // Draw Units
    gameState.units.forEach(u => {
        ctx.fillStyle = u.owner === myId ? '#fff' : '#ff5252';
        ctx.beginPath();
        ctx.arc(u.x, u.y, 15, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.fillText(u.type === 'worker' ? 'W' : 'S', u.x, u.y + 4);
    });

    if (isHost) conn.send({ type: 'SYNC', state: gameState });
    
    document.getElementById('res-wood').innerText = resources.wood;
    document.getElementById('res-gold').innerText = resources.gold;
    requestAnimationFrame(gameLoop);
}

// --- INTERACTION ---
function requestSpawn(type) {
    if (resources.gold < 20 && type === 'soldier') return;
    if (resources.wood < 50) return;

    if (isHost) {
        resources.wood -= 50;
        if(type === 'soldier') resources.gold -= 20;
        createUnit(myId, type, 100, 100);
    } else {
        conn.send({ type: 'SPAWN_REQ', unitType: type, sender: myId });
    }
}

function handleSpawnRequest(data) {
    // Host handles the actual spawning for guests
    createUnit(data.sender, data.unitType, (MAP_SIZE-3)*TILE_SIZE, (MAP_SIZE-3)*TILE_SIZE);
}

canvas.addEventListener('pointerdown', (e) => {
    const worldX = e.clientX;
    const worldY = e.clientY;
    
    // Command all my units to move
    if (isHost) {
        gameState.units.filter(u => u.owner === myId).forEach(u => {
            u.tx = worldX; u.ty = worldY;
        });
    } else {
        // Guest informs host of movement (simplified for this prototype: Guest updates local and waits for sync)
        gameState.units.filter(u => u.owner === myId).forEach(u => {
            u.tx = worldX; u.ty = worldY;
        });
    }
});

// Chat
document.getElementById('chat-input').addEventListener('keypress', e => {
    if (e.key === 'Enter' && e.target.value.trim()) {
        const msg = e.target.value;
        addChat("Me", msg);
        conn.send({ type: 'CHAT', sender: 'Friend', msg: msg });
        e.target.value = "";
    }
});

function addChat(sender, msg) {
    const log = document.getElementById('chat-log');
    log.innerHTML += `<div><b>${sender}:</b> ${msg}</div>`;
    log.scrollTop = log.scrollHeight;
}
</script>
</body>
</html>
